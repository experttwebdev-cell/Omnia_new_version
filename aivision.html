<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test AI Vision - Analyse d'Images</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    h1 {
      color: #f5576c;
      font-size: 32px;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #64748b;
      font-size: 16px;
    }
    .test-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    .two-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    .column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .image-upload {
      border: 3px dashed #e2e8f0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8fafc;
    }
    .image-upload:hover {
      border-color: #f5576c;
      background: #fff5f7;
    }
    .image-upload.dragover {
      border-color: #f5576c;
      background: #fff5f7;
      transform: scale(1.02);
    }
    .preview-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    input[type="text"], input[type="url"] {
      width: 100%;
      padding: 14px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #f5576c;
      box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.1);
    }
    button {
      padding: 14px 28px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
    }
    .logs {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 8px;
      padding: 4px 0;
    }
    .log-info { color: #60a5fa; }
    .log-success { color: #34d399; }
    .log-error { color: #f87171; }
    .log-warning { color: #fbbf24; }
    .results-card {
      background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 25px;
    }
    .results-card h3 {
      color: #1e293b;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .result-item {
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #f5576c;
    }
    .result-label {
      font-weight: 600;
      color: #475569;
      margin-bottom: 5px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .result-value {
      color: #1e293b;
      font-size: 16px;
    }
    .product-selector {
      margin-bottom: 20px;
    }
    .product-list {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
    }
    .product-item {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .product-item:hover {
      background: white;
    }
    .product-item.selected {
      background: linear-gradient(135deg, #fff5f7 0%, #ffffff 100%);
      border-left: 4px solid #f5576c;
    }
    .product-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    .product-info {
      flex: 1;
    }
    .product-name {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    .product-meta {
      font-size: 12px;
      color: #64748b;
    }
    .test-modes {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      color: #64748b;
      font-weight: 600;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-color: #f5576c;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 13px;
      opacity: 0.9;
    }
    .json-viewer {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üëÅÔ∏è Test AI Vision - Analyse d'Images</h1>
      <p class="subtitle">Test d'analyse d'images pour g√©n√©ration ALT text et enrichissement produits</p>
    </div>

    <div class="test-section">
      <h3 style="margin-bottom: 20px; color: #1e293b;">Mode de test</h3>

      <div class="test-modes">
        <button class="mode-btn active" onclick="setTestMode('url')">üîó URL Image</button>
        <button class="mode-btn" onclick="setTestMode('product')">üì¶ Produit Shopify</button>
        <button class="mode-btn" onclick="setTestMode('upload')">üì§ Upload Image</button>
      </div>

      <div class="two-columns">
        <div class="column">
          <!-- URL Mode -->
          <div id="urlMode" class="mode-content">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">URL de l'image</label>
              <input
                type="url"
                id="imageUrl"
                placeholder="https://example.com/image.jpg"
                value="https://images.unsplash.com/photo-1555041469-a586c61ea9bc"
              />
            </div>
            <button onclick="analyzeImageFromUrl()">üîç Analyser l'image</button>
          </div>

          <!-- Product Mode -->
          <div id="productMode" class="mode-content" style="display: none;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">S√©lectionner un produit</label>
              <button class="btn-secondary" onclick="loadProducts()">üì• Charger les produits</button>
            </div>
            <div class="product-list" id="productList"></div>
            <button onclick="analyzeSelectedProduct()" style="margin-top: 15px;">üîç Analyser les images du produit</button>
          </div>

          <!-- Upload Mode -->
          <div id="uploadMode" class="mode-content" style="display: none;">
            <div class="image-upload" id="dropZone">
              <div style="font-size: 48px; margin-bottom: 15px;">üì∏</div>
              <p style="color: #64748b; margin-bottom: 10px;">Glissez une image ici ou cliquez pour s√©lectionner</p>
              <input type="file" id="fileInput" accept="image/*" style="display: none;">
              <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">Choisir un fichier</button>
            </div>
          </div>

          <div id="previewContainer"></div>

          <div class="stats-grid" id="stats" style="display: none;">
            <div class="stat-box">
              <div class="stat-value" id="statTime">0ms</div>
              <div class="stat-label">Temps d'analyse</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="statImages">0</div>
              <div class="stat-label">Images analys√©es</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="statSuccess">0</div>
              <div class="stat-label">Succ√®s</div>
            </div>
          </div>
        </div>

        <div class="column">
          <div class="logs" id="logs"></div>

          <div class="results-card" id="resultsCard" style="display: none;">
            <h3>üìä R√©sultats de l'analyse</h3>
            <div id="results"></div>
          </div>

          <div class="results-card" id="jsonCard" style="display: none;">
            <h3>üìÑ JSON Brut</h3>
            <div class="json-viewer" id="jsonViewer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let supabase;
    let currentTestMode = 'url';
    let selectedProduct = null;

    function log(message, type = 'info') {
      const logs = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logs.insertBefore(entry, logs.firstChild);
    }

    function setTestMode(mode) {
      currentTestMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      document.querySelectorAll('.mode-content').forEach(el => el.style.display = 'none');
      document.getElementById(`${mode}Mode`).style.display = 'block';

      log(`Mode chang√©: ${mode}`, 'info');
    }

    async function loadProducts() {
      try {
        if (!supabase) {
          log('‚ùå Erreur: Supabase non initialis√©', 'error');
          return;
        }

        log('üì• Chargement des produits...', 'info');

        const { data: products, error } = await supabase
          .from('shopify_products')
          .select('id, title, image_url, featured_image, product_type, category')
          .limit(50);

        if (error) throw error;

        log(`‚úÖ ${products.length} produits charg√©s`, 'success');

        const listDiv = document.getElementById('productList');
        listDiv.innerHTML = '';

        products.forEach(product => {
          const item = document.createElement('div');
          item.className = 'product-item';
          item.onclick = () => selectProduct(product, item);

          const imageUrl = product.image_url || product.featured_image || 'https://via.placeholder.com/60';

          item.innerHTML = `
            <img src="${imageUrl}" class="product-thumbnail" onerror="this.src='https://via.placeholder.com/60'">
            <div class="product-info">
              <div class="product-name">${product.title}</div>
              <div class="product-meta">${product.product_type || 'NC'} ${product.category ? '‚Ä¢ ' + product.category : ''}</div>
            </div>
          `;

          listDiv.appendChild(item);
        });
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    function selectProduct(product, itemElement) {
      document.querySelectorAll('.product-item').forEach(el => el.classList.remove('selected'));
      itemElement.classList.add('selected');
      selectedProduct = product;
      log(`‚úÖ Produit s√©lectionn√©: ${product.title}`, 'success');
    }

    async function analyzeImageFromUrl() {
      const url = document.getElementById('imageUrl').value.trim();
      if (!url) {
        log('‚ö†Ô∏è Veuillez entrer une URL', 'warning');
        return;
      }

      showPreview(url);
      await analyzeImage(url, 'URL directe');
    }

    async function analyzeSelectedProduct() {
      if (!selectedProduct) {
        log('‚ö†Ô∏è Veuillez s√©lectionner un produit', 'warning');
        return;
      }

      log(`üîç Analyse du produit: ${selectedProduct.title}`, 'info');

      const { data: images, error } = await supabase
        .from('product_images')
        .select('*')
        .eq('product_id', selectedProduct.id)
        .order('position', { ascending: true });

      if (error) {
        log(`‚ùå Erreur de chargement des images: ${error.message}`, 'error');
        return;
      }

      if (images.length === 0) {
        log('‚ö†Ô∏è Aucune image trouv√©e pour ce produit', 'warning');
        return;
      }

      log(`üì∏ ${images.length} image(s) trouv√©e(s)`, 'info');

      for (const image of images) {
        showPreview(image.src);
        await analyzeImage(image.src, `Image ${image.position}`, selectedProduct.id, image.id);
      }
    }

    async function analyzeImage(imageUrl, context, productId = null, imageId = null) {
      const startTime = Date.now();

      try {
        log(`üîç Analyse de l'image: ${context}`, 'info');

        const apiUrl = `${window.ENV.VITE_SUPABASE_URL}/functions/v1/enrich-product-with-ai`;

        if (imageId) {
          log(`üéØ G√©n√©ration ALT text pour l'image ${imageId}`, 'info');

          const altUrl = `${window.ENV.VITE_SUPABASE_URL}/functions/v1/generate-alt-texts`;
          const altResponse = await fetch(altUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${window.ENV.VITE_SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ imageId })
          });

          if (altResponse.ok) {
            const altData = await altResponse.json();
            log(`‚úÖ ALT text g√©n√©r√©`, 'success');
            displayResults(altData, Date.now() - startTime);
          } else {
            const errorText = await altResponse.text();
            log(`‚ùå Erreur ALT: ${errorText}`, 'error');
          }
        } else {
          log('‚ö†Ô∏è Mode test URL - Analyse via OpenAI Vision directe', 'warning');
          log('ü§ñ Appel de l\'API OpenAI Vision...', 'info');

          // For URL-based testing, call OpenAI Vision API directly
          const openaiApiKey = window.ENV.VITE_OPENAI_API_KEY;

          if (!openaiApiKey || openaiApiKey.includes('__VITE_OPENAI_API_KEY__')) {
            log('‚ùå Cl√© OpenAI non configur√©e', 'error');

            const errorResult = {
              imageUrl,
              context,
              analysis: 'Cl√© API OpenAI manquante - Configurez VITE_OPENAI_API_KEY',
              color: 'N/A',
              material: 'N/A',
              style: 'N/A'
            };
            displayResults(errorResult, 0);
            return;
          }

          try {
            const visionResponse = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${openaiApiKey}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [{
                  role: 'user',
                  content: [
                    {
                      type: 'text',
                      text: 'Analyze this image and provide a JSON response with: alt_text (descriptive alt text), color (main color), material (primary material), style (design style), functionality (purpose/use), characteristics (key features). Respond ONLY with valid JSON, no markdown.'
                    },
                    {
                      type: 'image_url',
                      image_url: {
                        url: imageUrl,
                        detail: 'low'
                      }
                    }
                  ]
                }],
                max_tokens: 300,
                temperature: 0.3
              })
            });

            if (visionResponse.ok) {
              const visionData = await visionResponse.json();
              const aiContent = visionData.choices[0].message.content;

              log(`‚úÖ R√©ponse OpenAI re√ßue`, 'success');

              // Parse JSON from AI response
              let parsedData;
              try {
                parsedData = JSON.parse(aiContent);
              } catch (e) {
                const jsonMatch = aiContent.match(/```json\s*([\s\S]*?)\s*```/) ||
                                 aiContent.match(/```\s*([\s\S]*?)\s*```/) ||
                                 aiContent.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  parsedData = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                } else {
                  throw new Error('Could not extract JSON from response');
                }
              }

              const result = {
                imageUrl,
                context,
                analysis: parsedData.alt_text || 'N/A',
                color: parsedData.color || 'Non d√©tect√©e',
                material: parsedData.material || 'Non d√©tect√©e',
                style: parsedData.style || 'Non d√©tect√©',
                functionality: parsedData.functionality || 'N/A',
                characteristics: parsedData.characteristics || 'N/A'
              };

              displayResults(result, Date.now() - startTime);
            } else {
              const errorText = await visionResponse.text();
              log(`‚ùå Erreur OpenAI: ${errorText}`, 'error');

              // Check if it's a quota error
              let errorMessage = `Erreur API: ${visionResponse.status}`;
              try {
                const errorData = JSON.parse(errorText);
                if (errorData.error?.code === 'insufficient_quota') {
                  errorMessage = 'Quota OpenAI d√©pass√©. Utilisez le mode "Produit" pour tester avec vos produits.';
                  log('üí° Astuce: Le mode Produit utilise votre configuration compl√®te', 'info');
                }
              } catch (e) {
                // Keep default error message
              }

              const errorResult = {
                imageUrl,
                context,
                analysis: errorMessage,
                color: 'N/A',
                material: 'N/A',
                style: 'N/A'
              };
              displayResults(errorResult, Date.now() - startTime);
            }
          } catch (error) {
            log(`‚ùå Erreur: ${error.message}`, 'error');

            const errorResult = {
              imageUrl,
              context,
              analysis: `Erreur: ${error.message}`,
              color: 'N/A',
              material: 'N/A',
              style: 'N/A'
            };
            displayResults(errorResult, Date.now() - startTime);
          }
        }

        updateStats(Date.now() - startTime, 1, 1);

      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function showPreview(imageUrl) {
      const container = document.getElementById('previewContainer');
      container.innerHTML = `<img src="${imageUrl}" class="preview-image" alt="Preview">`;
    }

    function displayResults(data, time) {
      const card = document.getElementById('resultsCard');
      const resultsDiv = document.getElementById('results');
      card.style.display = 'block';

      resultsDiv.innerHTML = '';

      const fields = [
        { label: 'ALT Text', value: data.alt_text || data.analysis },
        { label: 'Couleur', value: data.color || data.ai_color || 'Non d√©tect√©e' },
        { label: 'Mati√®re', value: data.material || data.ai_material || 'Non d√©tect√©e' },
        { label: 'Style', value: data.style || data.ai_style || 'Non d√©tect√©' },
        { label: 'Fonctionnalit√©', value: data.functionality || 'NC' },
        { label: 'Caract√©ristiques', value: data.characteristics || 'NC' },
        { label: 'Temps', value: `${time}ms` }
      ];

      fields.forEach(field => {
        if (field.value && field.value !== 'NC' && field.value !== 'Non d√©tect√©e' && field.value !== 'Non d√©tect√©') {
          const item = document.createElement('div');
          item.className = 'result-item';
          item.innerHTML = `
            <div class="result-label">${field.label}</div>
            <div class="result-value">${field.value}</div>
          `;
          resultsDiv.appendChild(item);
        }
      });

      const jsonCard = document.getElementById('jsonCard');
      const jsonViewer = document.getElementById('jsonViewer');
      jsonCard.style.display = 'block';
      jsonViewer.textContent = JSON.stringify(data, null, 2);
    }

    function updateStats(time, images, success) {
      document.getElementById('stats').style.display = 'grid';
      document.getElementById('statTime').textContent = time + 'ms';
      document.getElementById('statImages').textContent = images;
      document.getElementById('statSuccess').textContent = success;
    }

    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    function handleFileUpload(file) {
      if (!file.type.startsWith('image/')) {
        log('‚ö†Ô∏è Le fichier doit √™tre une image', 'warning');
        return;
      }

      log(`üì§ Upload de ${file.name}`, 'info');

      const reader = new FileReader();
      reader.onload = (e) => {
        showPreview(e.target.result);
        log('‚úÖ Image charg√©e', 'success');
        log('üí° Mode upload - analyse manuelle n√©cessaire', 'info');
      };
      reader.readAsDataURL(file);
    }

    window.addEventListener('DOMContentLoaded', () => {
      // Check if config is loaded
      if (!window.ENV) {
        log('‚ùå Erreur: Configuration non charg√©e. Assurez-vous que config.js est charg√©.', 'error');
        console.error('window.ENV is undefined. Make sure /config.js is loaded properly.');
        return;
      }

      // Check if environment variables are set
      if (!window.ENV.VITE_SUPABASE_URL || !window.ENV.VITE_SUPABASE_ANON_KEY) {
        log('‚ùå Erreur: Variables d\'environnement manquantes', 'error');
        console.error('Environment variables missing:', {
          hasUrl: !!window.ENV.VITE_SUPABASE_URL,
          hasKey: !!window.ENV.VITE_SUPABASE_ANON_KEY
        });
        return;
      }

      // Initialize Supabase client
      try {
        supabase = window.supabase.createClient(
          window.ENV.VITE_SUPABASE_URL,
          window.ENV.VITE_SUPABASE_ANON_KEY
        );
        log('üöÄ Application initialis√©e', 'success');
        log('üí° Testez l\'analyse d\'images avec les diff√©rents modes', 'info');
      } catch (error) {
        log(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
        console.error('Failed to initialize Supabase:', error);
      }
    });
  </script>
</body>
</html>
