<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Email R√©initialisation - OmnIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üß™ Test Envoi Email de R√©initialisation</h1>
            <p class="text-gray-600 mb-6">Testez le syst√®me de r√©cup√©ration de mot de passe avec votre configuration SMTP O2switch</p>

            <!-- Configuration Display -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-blue-900 mb-2">üìã Configuration Actuelle:</h3>
                <div class="space-y-1 text-sm">
                    <p><span class="font-medium">SMTP Host:</span> ohio.o2switch.net</p>
                    <p><span class="font-medium">SMTP Port:</span> 465 (SSL/TLS)</p>
                    <p><span class="font-medium">From Email:</span> support@omnia.sale</p>
                    <p><span class="font-medium">Edge Function:</span> send-password-reset</p>
                    <p><span class="font-medium">Supabase URL:</span> <span id="supabaseUrl" class="text-blue-600"></span></p>
                </div>
            </div>

            <!-- Test Form -->
            <div class="border border-gray-200 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">üìß Test R√©initialisation Mot de Passe</h3>

                <form id="emailTestForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Email Destinataire *
                        </label>
                        <input
                            type="email"
                            id="testEmail"
                            required
                            placeholder="votre@email.com"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                        <p class="text-xs text-gray-500 mt-1">Utilisez une vraie adresse email que vous pouvez v√©rifier</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nom Complet
                        </label>
                        <input
                            type="text"
                            id="userName"
                            placeholder="Otmane BENYAHYA"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nom de l'entreprise
                        </label>
                        <input
                            type="text"
                            id="companyName"
                            placeholder="Decora Home"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                User ID (Test)
                            </label>
                            <input
                                type="text"
                                id="userId"
                                placeholder="069bb27f-d745-410c-a5d8-5224e2483d85"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Reset Token
                            </label>
                            <input
                                type="text"
                                id="resetToken"
                                placeholder="G√©n√©r√© automatiquement"
                                readonly
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500"
                            />
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button
                            type="submit"
                            id="sendButton"
                            class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105"
                        >
                            üîê Envoyer Email R√©initialisation
                        </button>
                        <button
                            type="button"
                            id="testApiButton"
                            class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105"
                        >
                            üß™ Tester API Route
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Display -->
            <div id="results" class="mt-6 hidden">
                <div id="resultContent" class="rounded-lg p-4"></div>
            </div>

            <!-- Logs Display -->
            <div id="logs" class="mt-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-3">üìù Logs</h3>
                <div id="logContent" class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm max-h-96 overflow-y-auto">
                    <p class="text-gray-400">En attente de test...</p>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">üìñ Instructions R√©initialisation</h2>

            <div class="space-y-4 text-gray-700">
                <div>
                    <h3 class="font-semibold text-lg mb-2">‚úÖ Avant de tester:</h3>
                    <ol class="list-decimal list-inside space-y-2 ml-4">
                        <li>Assurez-vous que l'Edge Function <code class="bg-gray-100 px-2 py-1 rounded">send-password-reset</code> est d√©ploy√©e</li>
                        <li>V√©rifiez que les secrets SMTP sont configur√©s dans Supabase</li>
                        <li>V√©rifiez que l'API route <code class="bg-gray-100 px-2 py-1 rounded">/api/auth/forgot-password</code> existe</li>
                        <li>Utilisez une vraie adresse email que vous pouvez v√©rifier</li>
                    </ol>
                </div>

                <div>
                    <h3 class="font-semibold text-lg mb-2">üß™ Deux M√©thodes de Test:</h3>
                    
                    <div class="ml-4 space-y-3">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold text-blue-900">üîê Edge Function Directe</h4>
                            <p class="text-sm text-blue-800">Appel direct de l'Edge Function Supabase avec tous les param√®tres</p>
                            <ul class="list-disc list-inside text-xs text-blue-700 mt-1">
                                <li>Teste la connexion SMTP directement</li>
                                <li>Contr√¥le total des param√®tres</li>
                                <li>Bypass l'API Next.js</li>
                            </ul>
                        </div>

                        <div class="p-3 bg-green-50 rounded-lg">
                            <h4 class="font-semibold text-green-900">üß™ API Route Next.js</h4>
                            <p class="text-sm text-green-800">Test du flux complet via votre API Next.js</p>
                            <ul class="list-disc list-inside text-xs text-green-700 mt-1">
                                <li>Teste l'int√©gration compl√®te</li>
                                <li>Simule le comportement r√©el de l'application</li>
                                <li>V√©rifie la logique m√©tier</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-lg mb-2">üîç Ce qui est test√©:</h3>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li>Connexion au serveur SMTP O2switch</li>
                        <li>Authentification SMTP avec vos credentials</li>
                        <li>Envoi d'email HTML professionnel en fran√ßais</li>
                        <li>G√©n√©ration du lien de r√©initialisation s√©curis√©</li>
                        <li>Int√©gration avec Supabase Edge Functions</li>
                        <li>R√©ponse de l'API Next.js</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-lg mb-2">‚ùå D√©pannage des Erreurs:</h3>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li><strong>CORS Error:</strong> Edge Function pas d√©ploy√©e ou probl√®me de configuration CORS</li>
                        <li><strong>SMTP Connection Failed:</strong> V√©rifiez host/port/credentials SMTP</li>
                        <li><strong>Authentication Failed:</strong> Mauvais username/mot de passe SMTP</li>
                        <li><strong>404 Error:</strong> Edge Function non trouv√©e - v√©rifiez le nom</li>
                        <li><strong>500 Error:</strong> Consultez les logs de l'Edge Function dans Supabase</li>
                    </ul>
                </div>

                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Important pour O2Switch:</h3>
                    <ul class="list-disc list-inside space-y-1 text-sm text-yellow-800">
                        <li>Port SMTP: <strong>465</strong> (SSL/TLS) ou <strong>587</strong> (STARTTLS)</li>
                        <li>Host: <strong>ohio.o2switch.net</strong></li>
                        <li>Username: <strong>support@omnia.sale</strong> (adresse email compl√®te)</li>
                        <li>Password: <strong>Seoplan@2024</strong></li>
                        <li>From Email: Doit correspondre au username SMTP</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ufdhzgqrubbnornjdvgv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZGh6Z3FydWJibm9ybmpkdmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjAwMzksImV4cCI6MjA3NTk5NjAzOX0.Xqfe56k9FU-85RBv9h1cxq1UvLU1tUsg24MAdzCqZms';

        // Display Supabase URL
        document.getElementById('supabaseUrl').textContent = SUPABASE_URL;

        // Generate reset token
        function generateResetToken() {
            return Math.random().toString(36).slice(-8) + Date.now().toString(36);
        }

        // Auto-generate reset token
        document.getElementById('testEmail').addEventListener('input', function() {
            if (!document.getElementById('resetToken').value) {
                document.getElementById('resetToken').value = generateResetToken();
            }
        });

        // Logging function
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };

            const logEntry = document.createElement('p');
            logEntry.className = `${colors[type]} mb-1`;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;

            // Clear "waiting" message on first log
            if (logContent.querySelector('.text-gray-400')) {
                logContent.innerHTML = '';
            }

            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Show results
        function showResult(success, message, details = null) {
            const results = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');

            results.classList.remove('hidden');

            if (success) {
                resultContent.className = 'bg-green-50 border border-green-200 rounded-lg p-4';
                resultContent.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-green-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-green-900 mb-1">‚úÖ Succ√®s!</h4>
                            <p class="text-green-800">${message}</p>
                            ${details ? `<pre class="mt-2 text-xs text-green-700 bg-green-100 p-2 rounded overflow-x-auto">${JSON.stringify(details, null, 2)}</pre>` : ''}
                        </div>
                    </div>
                `;
            } else {
                resultContent.className = 'bg-red-50 border border-red-200 rounded-lg p-4';
                resultContent.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-red-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-red-900 mb-1">‚ùå Erreur</h4>
                            <p class="text-red-800">${message}</p>
                            ${details ? `<pre class="mt-2 text-xs text-red-700 bg-red-100 p-2 rounded overflow-x-auto">${JSON.stringify(details, null, 2)}</pre>` : ''}
                        </div>
                    </div>
                `;
            }
        }

        // Test Edge Function directly
        async function testEdgeFunction() {
            const email = document.getElementById('testEmail').value;
            const userName = document.getElementById('userName').value || 'Otmane BENYAHYA';
            const resetToken = document.getElementById('resetToken').value || generateResetToken();

            const sendButton = document.getElementById('sendButton');
            const originalText = sendButton.innerHTML;

            // Disable button
            sendButton.disabled = true;
            sendButton.innerHTML = '‚è≥ Envoi Edge Function...';

            addLog('üöÄ D√©but test Edge Function directe...', 'info');
            addLog(`üìß Email: ${email}`, 'info');
            addLog(`üë§ Utilisateur: ${userName}`, 'info');
            addLog(`üîë Reset Token: ${resetToken}`, 'info');

            try {
                addLog('üì° Appel Edge Function send-password-reset...', 'info');

                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-password-reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify({
                        email,
                        reset_token: resetToken,
                        user_name: userName,
                    }),
                });

                addLog(`üì® R√©ponse HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                const data = await response.json();

                if (response.ok) {
                    addLog('‚úÖ Edge Function ex√©cut√©e avec succ√®s!', 'success');
                    addLog(`üì¨ Email envoy√© √†: ${email}`, 'success');
                    addLog('üîç V√©rifiez votre bo√Æte email (et spam)', 'warning');

                    const resetLink = `${window.location.origin}/reset-password?token=${resetToken}&email=${encodeURIComponent(email)}`;
                    addLog(`üîó Lien de r√©initialisation: ${resetLink}`, 'info');

                    showResult(
                        true,
                        `Email de r√©initialisation envoy√© avec succ√®s √† ${email}! V√©rifiez votre bo√Æte de r√©ception.`,
                        data
                    );
                } else {
                    addLog(`‚ùå Erreur Edge Function: ${data.error || 'Erreur inconnue'}`, 'error');
                    showResult(
                        false,
                        data.error || '√âchec de l\'envoi de l\'email via Edge Function',
                        data
                    );
                }

            } catch (error) {
                addLog(`üí• Exception: ${error.message}`, 'error');
                showResult(
                    false,
                    `Erreur lors de l'appel √† l'Edge Function: ${error.message}`,
                    { error: error.message }
                );
            } finally {
                // Re-enable button
                sendButton.disabled = false;
                sendButton.innerHTML = originalText;
                addLog('üèÅ Test Edge Function termin√©', 'info');
            }
        }

        // Test API Route
        async function testApiRoute() {
            const email = document.getElementById('testEmail').value;
            const testApiButton = document.getElementById('testApiButton');
            const originalText = testApiButton.innerHTML;

            // Disable button
            testApiButton.disabled = true;
            testApiButton.innerHTML = '‚è≥ Test API...';

            addLog('üß™ D√©but test API Route Next.js...', 'info');
            addLog(`üìß Email: ${email}`, 'info');
            addLog('üîç Simulation du flux complet de r√©initialisation...', 'info');

            try {
                addLog('üì° Appel API /api/auth/forgot-password...', 'info');

                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                    }),
                });

                addLog(`üì® R√©ponse HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                const data = await response.json();

                if (response.ok) {
                    addLog('‚úÖ API Route ex√©cut√©e avec succ√®s!', 'success');
                    addLog(`üí¨ Message: ${data.message}`, 'success');
                    
                    if (data.success) {
                        addLog('üì¨ Processus de r√©initialisation initi√©', 'success');
                        addLog('üîç V√©rifiez votre bo√Æte email (et spam)', 'warning');
                    }

                    showResult(
                        true,
                        `API Route ex√©cut√©e avec succ√®s: ${data.message}`,
                        data
                    );
                } else {
                    addLog(`‚ùå Erreur API: ${data.error || 'Erreur inconnue'}`, 'error');
                    showResult(
                        false,
                        data.error || '√âchec de l\'API Route',
                        data
                    );
                }

            } catch (error) {
                addLog(`üí• Exception: ${error.message}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    addLog('üîß API Route non trouv√©e - V√©rifiez le chemin /api/auth/forgot-password', 'warning');
                }

                showResult(
                    false,
                    `Erreur lors de l'appel √† l'API: ${error.message}`,
                    { error: error.message }
                );
            } finally {
                // Re-enable button
                testApiButton.disabled = false;
                testApiButton.innerHTML = originalText;
                addLog('üèÅ Test API Route termin√©', 'info');
            }
        }

        // Form submission for Edge Function
        document.getElementById('emailTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await testEdgeFunction();
        });

        // API Route test button
        document.getElementById('testApiButton').addEventListener('click', async (e) => {
            e.preventDefault();
            await testApiRoute();
        });

        // Initial log
        addLog('‚úÖ Page de test de r√©initialisation charg√©e', 'success');
        addLog(`üåê Supabase URL: ${SUPABASE_URL}`, 'info');
        addLog(`üîê Edge Function: send-password-reset`, 'info');
        addLog(`üß™ API Route: /api/auth/forgot-password`, 'info');
        addLog('üìù Remplissez le formulaire et choisissez une m√©thode de test', 'info');
        addLog('üí° Conseil: Testez d\'abord l\'Edge Function, puis l\'API Route', 'warning');
    </script>
</body>
</html>