<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Vision Color AI</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1a202c;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
    }
    input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    button {
      padding: 12px 24px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .product-info {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .product-info h3 {
      margin-top: 0;
      color: #1e40af;
    }
    .field {
      margin: 12px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
    }
    .field strong {
      color: #475569;
      display: inline-block;
      min-width: 200px;
    }
    .field .value {
      color: #1a202c;
    }
    .color-box {
      display: inline-block;
      width: 40px;
      height: 40px;
      border-radius: 4px;
      border: 2px solid #e2e8f0;
      margin-left: 12px;
      vertical-align: middle;
    }
    .success {
      color: #10b981;
      font-weight: 500;
    }
    .warning {
      color: #f59e0b;
      font-weight: 500;
    }
    .error {
      color: #ef4444;
      font-weight: 500;
    }
    .logs {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .log-entry {
      margin: 4px 0;
      padding: 4px 0;
      border-bottom: 1px solid #334155;
    }
    .log-success { color: #6ee7b7; }
    .log-warning { color: #fbbf24; }
    .log-error { color: #f87171; }
    .log-info { color: #93c5fd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Test Vision Color AI</h1>
    <p class="subtitle">Tester l'analyse couleur par Vision AI avec logs d√©taill√©s</p>

    <div class="controls">
      <input type="text" id="productId" placeholder="Product ID (laissez vide pour le premier produit avec images)">
      <button id="enrichBtn" onclick="enrichProduct()">Enrichir Produit</button>
    </div>

    <div id="productInfo" class="product-info" style="display:none;">
      <h3>üì¶ Informations Produit</h3>
      <div id="productDetails"></div>
    </div>

    <div id="logsContainer" style="display:none;">
      <h3>üìã Logs d'Enrichissement</h3>
      <div id="logs" class="logs"></div>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://ufdhzgqrubbnornjdvgv.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZGh6Z3FydWJibm9ybmpkdmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjAwMzksImV4cCI6MjA3NTk5NjAzOX0.Xqfe56k9FU-85RBv9h1cxq1UvLU1tUsg24MAdzCqZms';

    const { createClient } = supabase;
    const sb = createClient(supabaseUrl, supabaseAnonKey);

    window.sb = sb;

    function addLog(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(entry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    async function enrichProduct() {
      const btn = document.getElementById('enrichBtn');
      const logsContainer = document.getElementById('logsContainer');
      const logs = document.getElementById('logs');

      btn.disabled = true;
      btn.textContent = 'Enrichissement en cours...';
      logsContainer.style.display = 'block';
      logs.innerHTML = '';

      try {
        let productId = document.getElementById('productId').value.trim();

        if (!productId) {
          addLog('Recherche du premier produit avec images...', 'info');

          const { data: products, error: searchError } = await sb
            .from('shopify_products')
            .select('id, title')
            .not('image_url', 'is', null)
            .limit(1);

          if (searchError) throw searchError;
          if (!products || products.length === 0) {
            throw new Error('Aucun produit avec images trouv√©');
          }

          productId = products[0].id;
          addLog(`‚úì Produit trouv√©: ${products[0].title}`, 'success');
        }

        addLog(`Product ID: ${productId}`, 'info');

        // Charger les infos produit
        const { data: product, error: productError } = await sb
          .from('shopify_products')
          .select('id, title, ai_color, ai_vision_analysis, google_product_category')
          .eq('id', productId)
          .maybeSingle();

        if (productError) throw productError;
        if (!product) throw new Error('Produit non trouv√©');

        addLog('üì¶ Avant enrichissement:', 'warning');
        addLog(`  - Color: ${product.ai_color || 'vide'}`, 'warning');
        addLog(`  - Vision Analysis: ${product.ai_vision_analysis || 'vide'}`, 'warning');
        addLog(`  - Google Category: ${product.google_product_category || 'vide'}`, 'warning');

        // Appeler l'enrichissement
        addLog('üöÄ Appel de la fonction d\'enrichissement...', 'info');

        const { data: result, error: enrichError } = await sb.functions.invoke(
          'enrich-product-with-ai',
          {
            body: { productId }
          }
        );

        if (enrichError) {
          addLog(`‚ùå Erreur: ${enrichError.message}`, 'error');
          throw enrichError;
        }

        addLog('‚úÖ Enrichissement termin√©', 'success');

        // Recharger le produit
        const { data: updatedProduct, error: reloadError } = await sb
          .from('shopify_products')
          .select('*')
          .eq('id', productId)
          .maybeSingle();

        if (reloadError) throw reloadError;

        addLog('', 'info');
        addLog('‚ú® Apr√®s enrichissement:', 'success');
        addLog(`  - Color: ${updatedProduct.ai_color || 'TOUJOURS VIDE ‚ö†Ô∏è'}`, updatedProduct.ai_color ? 'success' : 'error');
        addLog(`  - Vision Analysis: ${updatedProduct.ai_vision_analysis?.substring(0, 80) || 'TOUJOURS VIDE ‚ö†Ô∏è'}...`, updatedProduct.ai_vision_analysis ? 'success' : 'error');
        addLog(`  - Google Category: ${updatedProduct.google_product_category || 'TOUJOURS VIDE ‚ö†Ô∏è'}`, updatedProduct.google_product_category ? 'success' : 'error');

        // Afficher les d√©tails
        const productInfo = document.getElementById('productInfo');
        const productDetails = document.getElementById('productDetails');

        productInfo.style.display = 'block';
        productDetails.innerHTML = `
          <div class="field">
            <strong>Titre:</strong>
            <span class="value">${updatedProduct.title}</span>
          </div>
          <div class="field">
            <strong>üé® Couleur (Vision AI):</strong>
            <span class="value ${updatedProduct.ai_color ? 'success' : 'error'}">
              ${updatedProduct.ai_color || '‚ùå Non d√©tect√©'}
            </span>
          </div>
          <div class="field">
            <strong>üëÅÔ∏è Analyse Visuelle:</strong>
            <span class="value ${updatedProduct.ai_vision_analysis ? 'success' : 'error'}">
              ${updatedProduct.ai_vision_analysis || '‚ùå Non g√©n√©r√©'}
            </span>
          </div>
          <div class="field">
            <strong>üè∑Ô∏è Google Category:</strong>
            <span class="value ${updatedProduct.google_product_category ? 'success' : 'error'}">
              ${updatedProduct.google_product_category || '‚ùå Non g√©n√©r√©'}
            </span>
          </div>
          <div class="field">
            <strong>üì¶ Mat√©riau:</strong>
            <span class="value">${updatedProduct.ai_material || 'N/A'}</span>
          </div>
          <div class="field">
            <strong>üé≠ Style:</strong>
            <span class="value">${updatedProduct.style || 'N/A'}</span>
          </div>
          <div class="field">
            <strong>üìê Dimensions:</strong>
            <span class="value">${updatedProduct.dimensions_text || 'N/A'}</span>
          </div>
        `;

        if (!updatedProduct.ai_color) {
          addLog('', 'info');
          addLog('‚ö†Ô∏è PROBL√àME: La couleur Vision n\'a pas √©t√© d√©tect√©e!', 'error');
          addLog('V√©rifiez les logs Supabase pour voir les d√©tails de Vision API', 'warning');
        }

      } catch (error) {
        addLog(`‚ùå ERREUR: ${error.message}`, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enrichir Produit';
      }
    }

    window.enrichProduct = enrichProduct;

    addLog('‚úì Page charg√©e - Pr√™t √† tester', 'success');
  </script>
</body>
</html>
